<tool name="SAM/BAM Alignment Summary Metrics" id="picard_CASM" version="1.121.0">
  <description>writes a file containing summary alignment metrics</description>
  <requirements>
    <requirement type="package" version="1.106.0">picard</requirement>
  </requirements>
  
  <macros>
    <import>picard_macros.xml</import>
  </macros>
  
  <command>
    @java_options@
    ##set up input files

    #set $reference_fasta_filename = "localref.fa"
    
    #if str( $reference_source.reference_source_selector ) == "history":
        ln -s "${reference_source.ref_file}" "${reference_fasta_filename}" &amp;&amp;
    #else:
        #set $reference_fasta_filename = str( $reference_source.ref_file.fields.path )
    #end if
    
    java -jar \$JAVA_JAR_PATH/CollectAlignmentSummaryMetrics.jar
    INPUT="${inputFile}"
    OUTPUT="${outFile}"
    MAX_INSERT_SIZE=${maxinsert}
    #for $sequence in $adapters:
        ADAPTER_SEQUENCE="${sequence.adapter}"
    #end for
    METRIC_ACCUMULATION_LEVEL="${metric_accumulation_level}"
    IS_BISULFITE_SEQUENCED="${bisulphite}"
    
    REFERENCE_SEQUENCE="${reference_fasta_filename}"
    
    ASSUME_SORTED="${sorted}"
    ##STOP_AFTER="${}
    VALIDATION_STRINGENCY="${validation_stringency}"
    QUIET=true
    VERBOSITY=ERROR
  
  </command>
  <inputs>
    <param format="sam,bam" name="inputFile" type="data" label="SAM/BAM dataset to generate statistics for" help="If empty, upload or import a SAM/BAM dataset."/>
    <conditional name="reference_source">
      <param name="reference_source_selector" type="select" label="Load reference genome from">
        <option value="cached">Local cache</option>
        <option value="history">History</option>
      </param>
      <when value="cached">
        <param name="ref_file" type="select" label="Using reference genome" help="REFERENCE_SEQUENCE">
          <options from_data_table="all_fasta">
          </options>
          <validator type="no_options" message="A built-in reference genome is not available for the build associated with the selected input file"/>
        </param>
      </when>
      <when value="history">
        <param name="ref_file" type="data" format="fasta" label="Use the folloing dataset as the reference sequence" help="REFERENCE_SEQUENCE; You can upload a FASTA sequence to the history and use it as reference" />
      </when>
    </conditional>
    <param name="metric_accumulation_level" type="select" label="The level(s) at which to accumulate metrics" multiple="true" help="METRIC_ACCUMULATION_LEVEL">
      <option value="ALL_READS" selected="True">All reads</option>
      <option value="SAMPLE">Sample</option>
      <option value="LIBRARY">Library</option>
      <option value="READ_GROUP">Read group</option>
    </param>
    <param name="sorted" type="boolean" label="Assume the input file is already sorted" checked="true" truevalue="true" falsevalue="false" help="ASSUME_SORTED"/>
    <param name="bisulphite" type="boolean" label="Input file contains Bisulphite sequenced reads" checked="false" falsevalue="false" truevalue="true" help="IS_BISULFITE_SEQUENCED"/>
    <repeat name="adapters" title="Adapter(s)" min="0" help="You can provide multiple adaptor sequences">
          <param name="adapter" type="text" size="50" label="Use this adaptor sequence" help="ADAPTER_SEQUENCE"/>
    </repeat>
    <param name="maxinsert" value="100000" type="integer" label="Larger paired end reads and inter-chromosomal pairs considered chimeric" size="20" help="MAX_INSERT_SIZE"/>
    
    <expand macro="VS" />
    
  </inputs>
  
  <outputs>
    <data format="tabular" name="outFile"/>
  </outputs>
  
  <stdio>
    <exit_code range="1:"  level="fatal"/>
  </stdio>
  
  
  <tests>
    <test>
      <param name="bisulphite" value="false" />
      <param name="sorted" value="true" />
      <param name="adaptors" value="" />
      <param name="maxinsert" value="100000" />
      <param name="reference_source_selector" value="history" />
      <param name="ref_file" value="picard_CASM_ref.fa" />
      <param name="inputFile" value="picard_CASM.bam" ftype="bam" />
      <output name="outFile" file="picard_CASM_test1.tab" ftype="tabular" lines_diff="4"/>
    </test>
  </tests>
  
  <help>

.. class:: infomark

**Purpose**

Reads a SAM or BAM file and writes a file containing summary alignment metrics.

@description@

  MAX_INSERT_SIZE=Integer       Paired end reads above this insert size will be considered chimeric along with 
                                inter-chromosomal pairs.  Default value: 100000.  

  ADAPTER_SEQUENCE=String       List of adapter sequences to use when processing the alignment metrics  This option may 
                                be specified 0 or more times.  

  METRIC_ACCUMULATION_LEVEL=MetricAccumulationLevel
  LEVEL=MetricAccumulationLevel The level(s) at which to accumulate metrics.    Possible values: {ALL_READS, SAMPLE, 
                                LIBRARY, READ_GROUP} This option may be specified 0 or more times.  

  IS_BISULFITE_SEQUENCED=Boolean
  BS=Boolean                    Whether the SAM or BAM file consists of bisulfite sequenced reads.    


  REFERENCE_SEQUENCE=File
  R=File                        Reference sequence fasta  Default value: null. 

  ASSUME_SORTED=Boolean
  AS=Boolean                    If true (default), then the sort order in the header file will be ignored. 

@more_info@

  </help>
</tool>


